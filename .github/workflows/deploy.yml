name: Deploy KRSTUDIO AI VISION

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # שלב 1: סינכרון קבצים לשרת עם rsync
      - name: Sync project to VPS via rsync
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/krstudio-ai-vision

      # שלב 2: פקודות על השרת (npm install, build, pm2 restart)
      - name: Run remote commands on VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/krstudio-ai-vision

            # התקנת תלויות צד שרת
            npm install --production=false

            # התקנת תלויות לקליינט + בנייה
            cd client
            npm install
            npm run build
            cd ..

            # הפעלת שרת Node עם PM2 (או ריסטארט אם כבר קיים)
            if pm2 list | grep -q "krstudio-ai-vision"; then
              pm2 restart krstudio-ai-vision
            else
              pm2 start server.js --name krstudio-ai-vision
            fi

            pm2 save
